See the code in 7.x-1.x branch.
